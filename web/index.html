<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Tree generator</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        font-family: sans-serif;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
      }
      button {
        margin: 2px;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <label>
        Seed:
        <input id="seedInput" type="number" value="1234" />
      </label>
      <br /><br />
      <label>
        Straightness:
        <button id="decreaseStraightness">-</button>
        <span id="straightnessValue">2</span>
        <button id="increaseStraightness">+</button>
      </label>
      <br /><br />
      <label>
        Segment Length:
        <input id="segmentLengthInput" type="number" step="0.1" min="0.1" max="1.0" value="0.3" />
      </label>
      <br /><br />
      <button id="generateBtn">Generate Tree</button>
      <button id="growBtn">Grow</button>
    </div>

    <canvas id="treeCanvas"></canvas>

    <script type="module">
      import init, { generate } from "/static/js/tree_rs.js";

      async function main() {
        await init();

        const canvas = document.getElementById("treeCanvas");
        const ctx = canvas.getContext("2d");
        const seedInput = document.getElementById("seedInput");
        const straightnessValue = document.getElementById("straightnessValue");
        const increaseStraightnessBtn = document.getElementById("increaseStraightness");
        const decreaseStraightnessBtn = document.getElementById("decreaseStraightness");
        const generateBtn = document.getElementById("generateBtn");
        const growBtn = document.getElementById("growBtn");

        let straightness = 2;
        let tree = null;
        let isGrowing = false;
        let growInterval = null;
        const meterToPixel = 100;
        const GROW_INTERVAL_MS = 50;

        function resizeCanvas() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        function generateTree(seed, straightness) {
            // Call Rust function
            const tree = generate(seed, 1, 0.3, straightness);
            console.log("Rust generate:", tree);
            return tree;
        }

        function drawTree(tree, seed, straightness) {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const branches = tree.branches();
            console.log("branches:", branches);
            const padding = 40;
            const offsetX = canvas.width / 2;
            const offsetY = canvas.height - padding;

            for (let i = 0; i < branches.length; i++) {
                const branch = branches[i];
                const length = branch.length;
                const radius = branch.radius;
                ctx.beginPath();
                ctx.moveTo(offsetX + branch.start.x * meterToPixel, offsetY - branch.start.y * meterToPixel);
                ctx.lineTo(offsetX + branch.end.x * meterToPixel, offsetY - branch.end.y * meterToPixel);
                ctx.strokeStyle = "black";
                ctx.lineWidth = radius * meterToPixel;
                ctx.stroke();
            }
        }

        function toggleGrow() {
          isGrowing = !isGrowing;
          growBtn.textContent = isGrowing ? 'Stop' : 'Grow';
          
          if (isGrowing) {
            const seed = parseInt(seedInput.value, 10) || 0;
            if (!tree) {
              tree = generateTree(seed, straightness);
            }
            growInterval = setInterval(() => {
              tree.grow();
              drawTree(tree, seed, straightness);
            }, GROW_INTERVAL_MS);
          } else {
            if (growInterval) {
              clearInterval(growInterval);
              growInterval = null;
            }
          }
        }

        growBtn.addEventListener("click", toggleGrow);

        increaseStraightnessBtn.addEventListener("click", () => {
          straightness++;
          straightnessValue.textContent = straightness;
        });

        decreaseStraightnessBtn.addEventListener("click", () => {
          straightness = Math.max(0, straightness - 1);
          straightnessValue.textContent = straightness;
        });

        generateBtn.addEventListener("click", () => {
          const seed = parseInt(seedInput.value, 10) || 0;
          tree = generateTree(seed, straightness);
          drawTree(tree, seed, straightness);
        });

        // Initial draw
        tree = generateTree(parseInt(seedInput.value, 10), straightness);
        drawTree(tree, parseInt(seedInput.value, 10), straightness);
      }

      // Clean up interval when page unloads
      window.addEventListener('beforeunload', () => {
        if (growInterval) {
          clearInterval(growInterval);
        }
      });

      main();
    </script>
  </body>
</html>
