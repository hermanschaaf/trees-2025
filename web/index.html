<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Tree generator</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        font-family: sans-serif;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
      }
      button {
        margin: 2px;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <label>
        Seed:
        <input id="seedInput" type="number" value="1234" />
      </label>
      <br /><br />
      <div>
        <strong>Straightness:</strong>
        <div style="margin-left: 10px;">
          <label>
            Distribution:
            <select id="straightnessDistType">
              <option value="normal">Normal</option>
              <option value="uniform">Uniform</option>
              <option value="poisson">Poisson</option>
            </select>
          </label>
          <br />
          <label>
            Location (μ/λ):
            <input id="straightnessLoc" type="number" step="0.1" value="2.0" />
          </label>
          <br />
          <label>
            Scale (σ):
            <input id="straightnessScale" type="number" step="0.1" value="0.5" min="0.1" />
          </label>
        </div>
      </div>
      <br />
      <div>
        <strong>Segment Length:</strong>
        <div style="margin-left: 10px;">
          <label>
            Distribution:
            <select id="segmentDistType">
              <option value="normal">Normal</option>
              <option value="uniform">Uniform</option>
              <option value="poisson">Poisson</option>
            </select>
          </label>
          <br />
          <label>
            Location (μ/λ):
            <input id="segmentLoc" type="number" step="0.1" value="0.3" min="0.1" />
          </label>
          <br />
          <label>
            Scale (σ):
            <input id="segmentScale" type="number" step="0.1" value="0.1" min="0.01" />
          </label>
        </div>
      </div>
      <br />
      <div>
        <strong>Angle:</strong>
        <div style="margin-left: 10px;">
          <label>
            Distribution:
            <select id="angleDistType">
              <option value="normal">Normal</option>
              <option value="uniform">Uniform</option>
              <option value="poisson">Poisson</option>
            </select>
          </label>
          <br />
          <label>
            Location (μ/λ):
            <input id="angleLoc" type="number" step="0.1" value="0.3" min="0.1" />
          </label>
          <br />
          <label>
            Scale (σ):
            <input id="angleScale" type="number" step="0.1" value="0.1" min="0.01" />
          </label>
        </div>
      </div>
      <br /><br />
      <button id="generateBtn">Generate Tree</button>
      <button id="growBtn">Grow</button>
    </div>

    <canvas id="treeCanvas"></canvas>

    <script type="module">
      import init, { generate } from "/static/js/tree_rs.js";

      async function main() {
        await init();

        const canvas = document.getElementById("treeCanvas");
        const ctx = canvas.getContext("2d");
        const seedInput = document.getElementById("seedInput");
        const straightnessDistType = document.getElementById("straightnessDistType");
        const straightnessLoc = document.getElementById("straightnessLoc");
        const straightnessScale = document.getElementById("straightnessScale");
        const segmentDistType = document.getElementById("segmentDistType");
        const segmentLoc = document.getElementById("segmentLoc");
        const segmentScale = document.getElementById("segmentScale");
        const angleDistType = document.getElementById("angleDistType");
        const angleLoc = document.getElementById("angleLoc");
        const angleScale = document.getElementById("angleScale");
        const generateBtn = document.getElementById("generateBtn");
        const growBtn = document.getElementById("growBtn");
        let tree = null;
        let isGrowing = false;
        let growInterval = null;
        const meterToPixel = 200;
        const GROW_INTERVAL_MS = 50;

        // Preload the image once
        const personImg = new Image();
        personImg.crossOrigin = "anonymous";
        personImg.src = "/static/images/man.svg";

        personImg.onload = function() {
          // Start animation only after image is ready
          requestAnimationFrame(drawAll);
        };

        function resizeCanvas() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        function createDistributionParams(distType, loc, scale) {
            return { dist_type: distType, loc, scale };
        }

        function generateTree(seed) {
            try {
                // Get distribution parameters
                const straightnessParams = createDistributionParams(
                    straightnessDistType.value,
                    parseFloat(straightnessLoc.value),
                    parseFloat(straightnessScale.value)
                );
                const segmentParams = createDistributionParams(
                    segmentDistType.value,
                    parseFloat(segmentLoc.value),
                    parseFloat(segmentScale.value)
                );
                const angleParams = createDistributionParams(
                    angleDistType.value,
                    parseFloat(angleLoc.value),
                    parseFloat(angleScale.value)
                );
                
                // Call Rust function with distribution parameters
                const tree = generate(seed, segmentParams, straightnessParams, angleParams);
                console.log("Rust generate:", tree);
                return tree;
            } catch (error) {
                console.error("Error generating tree:", error);
                throw error;
            }
        }

        function drawAll() {
          const offCanvas = document.createElement("canvas");
          offCanvas.width = canvas.width;
          offCanvas.height = canvas.height;
          const offCtx = offCanvas.getContext("2d");

          offCtx.clearRect(0, 0, offCanvas.width, offCanvas.height);

          drawPersonForScale(offCtx);
          drawTree(offCtx, tree);

          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(offCanvas, 0, 0);

          requestAnimationFrame(drawAll);
        }

        function drawPersonForScale(ctx) {
          const padding = 40;
          const offsetX = canvas.width / 2 + 1.5 * meterToPixel;
          const offsetY = canvas.height - padding;

          ctx.globalAlpha = 0.5;
          ctx.drawImage(
            personImg,
            offsetX - meterToPixel * 0.5,
            offsetY - meterToPixel * 1.8,
            meterToPixel * 0.5,
            meterToPixel * 1.8
          );
          ctx.globalAlpha = 1.0; // reset
        }

        function drawTree(ctx, tree) {
            const branches = tree.branches();
            const padding = 40;
            const offsetX = canvas.width / 2;
            const offsetY = canvas.height - padding;
            const maxCounter = Math.max(...branches.map(branch => branch.counter));
            const maxDepth = Math.max(...branches.map(branch => branch.depth));

            for (let i = 0; i < branches.length; i++) {
                const branch = branches[i];
                const length = branch.length;
                const radius = branch.radius;
                ctx.beginPath();
                ctx.moveTo(offsetX + branch.start.x * meterToPixel, offsetY - branch.start.y * meterToPixel);
                ctx.lineTo(offsetX + branch.end.x * meterToPixel, offsetY - branch.end.y * meterToPixel);
                
                const normalizedCounter = Math.min(branch.counter / maxCounter, 1.0);
                const normalizedDepth = Math.min(branch.depth / maxDepth, 1.0);
                const hue = 30 + (120 - 30) * normalizedDepth;
                const saturation = 70 + 30 * normalizedDepth;
                const lightness = 30 + 20 * (1 - normalizedDepth);
                
                ctx.strokeStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                ctx.lineWidth = radius * meterToPixel;
                ctx.stroke();
            }

            for (let i = 0; i < branches.length; i++) {
                const branch = branches[i];
                const normalizedCounter = Math.min(branch.counter / maxCounter, 1.0);
                const hue = 30 + (120 - 30) * normalizedCounter;
                const saturation = 70 + 30 * normalizedCounter;
                const lightness = 30 + 20 * (1 - normalizedCounter);
                // draw the branch counter
                ctx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                ctx.font = "12px Arial";
                ctx.fillText(branch.counter.toString(), offsetX + branch.end.x * meterToPixel, offsetY - branch.end.y * meterToPixel);
            }
        }

        function toggleGrow() {
          isGrowing = !isGrowing;
          growBtn.textContent = isGrowing ? 'Stop' : 'Grow';
          
          if (isGrowing) {
            const seed = parseInt(seedInput.value, 10) || 0;
            if (!tree) {
              tree = generateTree(seed);
            }
            growInterval = setInterval(() => {
              tree.grow();
            }, GROW_INTERVAL_MS);
          } else {
            if (growInterval) {
              clearInterval(growInterval);
              growInterval = null;
            }
          }
        }

        growBtn.addEventListener("click", toggleGrow);

        generateBtn.addEventListener("click", () => {
          try {
            const seed = parseInt(seedInput.value, 10) || 0;
            tree = generateTree(seed);
            // drawAll();
          } catch (error) {
            console.error("Error generating tree:", error);
            alert(`Error generating tree: ${error.message}`);
          }
        });

        // Initial draw
        try {
            tree = generateTree(parseInt(seedInput.value, 10));
            drawAll();
        } catch (error) {
            console.error("Error in initial tree generation:", error);
        }
      }

      // Clean up interval when page unloads
      window.addEventListener('beforeunload', () => {
        if (growInterval) {
          clearInterval(growInterval);
        }
      });

      main();
    </script>
  </body>
</html>
