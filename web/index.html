<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Tree generator</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        font-family: sans-serif;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
      }
      button {
        margin: 2px;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <label>
        Seed:
        <input id="seedInput" type="number" value="1234" />
      </label>
      <br /><br />
      <div>
        <strong>Straightness:</strong>
        <div style="margin-left: 10px;">
          <label>
            Distribution:
            <select id="straightnessDistType">
              <option value="normal">Normal</option>
              <option value="uniform">Uniform</option>
              <option value="poisson">Poisson</option>
            </select>
          </label>
          <br />
          <label>
            Location (μ/λ):
            <input id="straightnessLoc" type="number" step="0.1" value="2.0" />
          </label>
          <br />
          <label>
            Scale (σ):
            <input id="straightnessScale" type="number" step="0.1" value="0.5" min="0.1" />
          </label>
        </div>
      </div>
      <br />
      <div>
        <strong>Segment Length:</strong>
        <div style="margin-left: 10px;">
          <label>
            Distribution:
            <select id="segmentDistType">
              <option value="normal">Normal</option>
              <option value="uniform">Uniform</option>
              <option value="poisson">Poisson</option>
            </select>
          </label>
          <br />
          <label>
            Location (μ/λ):
            <input id="segmentLoc" type="number" step="0.1" value="0.3" min="0.1" />
          </label>
          <br />
          <label>
            Scale (σ):
            <input id="segmentScale" type="number" step="0.1" value="0.1" min="0.01" />
          </label>
        </div>
      </div>
      <br /><br />
      <button id="generateBtn">Generate Tree</button>
      <button id="growBtn">Grow</button>
    </div>

    <canvas id="treeCanvas"></canvas>

    <script type="module">
      import init, { generate } from "/static/js/tree_rs.js";

      async function main() {
        await init();

        const canvas = document.getElementById("treeCanvas");
        const ctx = canvas.getContext("2d");
        const seedInput = document.getElementById("seedInput");
        const straightnessDistType = document.getElementById("straightnessDistType");
        const straightnessLoc = document.getElementById("straightnessLoc");
        const straightnessScale = document.getElementById("straightnessScale");
        const segmentDistType = document.getElementById("segmentDistType");
        const segmentLoc = document.getElementById("segmentLoc");
        const segmentScale = document.getElementById("segmentScale");
        const generateBtn = document.getElementById("generateBtn");
        const growBtn = document.getElementById("growBtn");
        let tree = null;
        let isGrowing = false;
        let growInterval = null;
        const meterToPixel = 100;
        const GROW_INTERVAL_MS = 50;

        function resizeCanvas() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        function createDistributionParams(distType, loc, scale) {
            return { dist_type: distType, loc, scale };
        }

        function generateTree(seed) {
            try {
                // Get distribution parameters
                const straightnessParams = createDistributionParams(
                    straightnessDistType.value,
                    parseFloat(straightnessLoc.value),
                    parseFloat(straightnessScale.value)
                );
                const segmentParams = createDistributionParams(
                    segmentDistType.value,
                    parseFloat(segmentLoc.value),
                    parseFloat(segmentScale.value)
                );
                
                // Call Rust function with distribution parameters
                const tree = generate(seed, segmentParams, straightnessParams);
                console.log("Rust generate:", tree);
                return tree;
            } catch (error) {
                console.error("Error generating tree:", error);
                throw error;
            }
        }

        function drawTree(tree) {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const branches = tree.branches();
            console.log("branches:", branches);
            const padding = 40;
            const offsetX = canvas.width / 2;
            const offsetY = canvas.height - padding;

            for (let i = 0; i < branches.length; i++) {
                const branch = branches[i];
                const length = branch.length;
                const radius = branch.radius;
                ctx.beginPath();
                ctx.moveTo(offsetX + branch.start.x * meterToPixel, offsetY - branch.start.y * meterToPixel);
                ctx.lineTo(offsetX + branch.end.x * meterToPixel, offsetY - branch.end.y * meterToPixel);
                ctx.strokeStyle = "black";
                ctx.lineWidth = radius * meterToPixel;
                ctx.stroke();
            }
        }

        function toggleGrow() {
          isGrowing = !isGrowing;
          growBtn.textContent = isGrowing ? 'Stop' : 'Grow';
          
          if (isGrowing) {
            const seed = parseInt(seedInput.value, 10) || 0;
            if (!tree) {
              tree = generateTree(seed, straightness);
            }
            growInterval = setInterval(() => {
              tree.grow();
              drawTree(tree);
            }, GROW_INTERVAL_MS);
          } else {
            if (growInterval) {
              clearInterval(growInterval);
              growInterval = null;
            }
          }
        }

        growBtn.addEventListener("click", toggleGrow);



        generateBtn.addEventListener("click", () => {
          try {
            const seed = parseInt(seedInput.value, 10) || 0;
            tree = generateTree(seed);
            drawTree(tree);
          } catch (error) {
            console.error("Error generating tree:", error);
            alert(`Error generating tree: ${error.message}`);
          }
        });

        // Initial draw
        try {
            tree = generateTree(parseInt(seedInput.value, 10));
            drawTree(tree);
        } catch (error) {
            console.error("Error in initial tree generation:", error);
        }
        drawTree(tree);
      }

      // Clean up interval when page unloads
      window.addEventListener('beforeunload', () => {
        if (growInterval) {
          clearInterval(growInterval);
        }
      });

      main();
    </script>
  </body>
</html>
